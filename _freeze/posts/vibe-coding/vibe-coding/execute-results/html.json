{
  "hash": "451c4eb1554e382f80a28bc82bff8bf7",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"'Vibe Coding' my way into a RAG pipeline\"\nsubtitle: \"Retrieval-augmented generation with a little help from a friend.\"\nauthor: Gio Circo, Ph.D.\ndate: 2025-3-10\ncategories:\n  - Python\n  - Data Science Applications\nformat: \n    html:\n        self-contained: true\n        code-fold: false\n        mainfont: \"Roboto\"\n        section-divs: true\n        toc: true\n        title-block-banner: true\n        mermaid:\n            theme: neutral\ntheme: flatly\nimage: prompt-testing.png\n---\n\n\n*There are synthesized depictions of self-harm and suicide in this blog post.*\n\n## LLMs and RAG\n\nFor most people who are up-to-date in tech, large language models (LLMs) are nothing new. In fact, they are downright pervasive. One of the largest challenges with LLMs today is that they are very good at coming up with plausible-sounding answers, but less good at telling us *why* or *where* they got that answer from. Many times we have to cast a critical eye at LLM output and determine whether or not it is real or just a hallucination. From the beginning, it was suggested that we could augment a user's prompt with a set of relevent documents that could be used to verify the output of the LLM, or improve the prompt itself. For example, imagine we [wrote a prompt](https://chatgpt.com/share/67cf3c21-fd18-8007-a043-6eaec436e169) asking an LLM about [parking restrictions](https://newyork.public.law/laws/n.y._vehicle_and_traffic_law_section_1202) in New York State:\n\n> **Q:** Is it permitted to park between roadways on a highway according to New York State law?\\\n> **A:** According to New York State law, parking between roadways on a highway is not permitted, except where official signs indicate otherwise. Specifically, Section 1200 of the New York Vehicle and Traffic Law states that parking is prohibited in areas such as medians, between divided roadways, and other restricted zones unless otherwise posted.\n\nversus:\n\n> **Q:** Is it permitted to park between roadways on a highway according to New York State law? Review the following rules from the New York Vehicle and Traffic Law. Provide direct quotes to support your answer: *\\[full text of Vehicle & Traffic Law Section 1202\\]*\n>\n> **A:** No, it is not permitted according to New York Vehicle and Traffic Law. The law explicitly states:\n>\n> > *“No person shall stop, stand or park a vehicle... in the area between roadways of a divided highway, including crossovers, except in an emergency.”*\n>\n> This is found under Section 1(i) of the provided rules. The only exception is in the case of an emergency.\n\nThis is a bit of a contrived example, but the general idea here is that we can improve the LLMs by providing them relevant external information alongside their instructions. By including extra information this helps to guard against hallucinations, and can also give the user more guidance on why the LLM came to its specific answer. In our answer above, the LLM is technically correct in the first answer that parking is not permitted - but I think it invents a rule about official signs allowing otherwise. In the prompt containing the full-text of the relevent set of rules, we get a much shorter, cleaner response with the precise rule relevant to the question.\n\n## Coding Out a RAG Pipeline\n\nIn a [recent blog post](https://gmcirco.github.io/blog/posts/prompt-testing/prompt_testing.html) I walked through a step-by-step process of how to set up a A/B testing process for prompt refinement. I relied on data from a recent [DrivenData](https://www.drivendata.org/competitions/295/cdc-automated-abstraction/page/917/) competition that relied on youth suicide narrative reports from the [National Violent Death Reporting System](https://www.cdc.gov/nvdrs/resources/nvdrsCodingManual.pdf). I was pretty happy with the workflow I built out, but couldn't help but feel that I could improve it somehow by giving the LLM direct access to the relevant sections from the coding manual. Here is where RAG comes in! Rather than prompting the model with upwards of 200 pages of text, of which it might need less than 1 page, I could pass just the smallest subsections for each question.\n\n### My mental model\n\nThe way I envisioned this working was to process the RAG step separately by indexing the relevant sub-sections from section 5 of NVDRS coding manual. I would extract out the subsection chunks and then index them in vector database for retreval at the time of prompt creation. My prompt creator class adds the headers, instructions, and questions to the final prompt, and then we tack on the relevant rules from the vector database (see below):\n\n\n```{mermaid}\nflowchart LR\n    %% Improved node styling\n    classDef input fill:#c4e3f3,stroke:#5bc0de,stroke-width:2px,color:#31708f\n    classDef process fill:#d9edf7,stroke:#5bc0de,stroke-width:2px,color:#31708f\n    classDef database fill:#dff0d8,stroke:#5cb85c,stroke-width:2px,color:#3c763d\n    classDef output fill:#fcf8e3,stroke:#f0ad4e,stroke-width:2px,color:#8a6d3b\n    \n    %% Main components with better descriptions\n    A[\"NVDRS Manual<br/>(Source Document)\"] -->|\"Reference material\"| B\n    B[\"RAG Model<br/>(Retrieval System)\"] --> D\n    C[\"Narrative Text<br/>(Case Information)\"] -->|\"Contains: '...victim felt depressed..'\"| D\n    C --> E\n    \n    %% Database and outputs\n    D[(\"Vector Database<br/>(Knowledge Store)\")] -->|\"Retrieved: '5.3.4 Current depressed mood:'\"| F\n    E[\"Prompt Creator<br/>(Question Generator)\"] -->|\"Generates: Q1, Q2, Q3\"| F\n    \n    %% Final output\n    F[\"Final Prompt<br/>(For LLM Processing)\"]\n    \n    %% Apply styles\n    class A,C input\n    class B,E process\n    class D database\n    class F output\n\n```\n\n\nIn my mind, I figured I could come up with a quick and dirty solution by using regex to hit on key words in the narrative, and then use a semantic similarity model (like `SentenceTransformers`) to retrieve the top $n$ rules. For example, a narrative might have a section stating:\n\n> \"Victim had been feeling **depressed** and sad in the days leading up to the incident\"\n\nWe use regex to grab the relevant words around our matched word (here, **depressed**), encode them, and then retrieve rules from the vector database. In the last step we append these to our prompt before executing it.\n\nThere's just one problem - I've never done this before.\n\n### Vibe-Coding\n\nWhat is \"vibe coding\"? One of my favorite definitions comes from ex-OpenAI founder Andrej Karpathy:\n\n> \"There's a new kind of coding I call \"vibe coding\", where you fully give in to the vibes, embrace exponentials, and forget that the code even exists\"\n\nIn short, it represents a programmer's full surrender to the LLM, and taking what it gives back on good faith. When problems arrive, you just dig deeper and let the LLM guide you even further down the rabbit hole, trusting the process. I think the term is very funny - but there is a bit of truth to this. \"Vibe-Coding\" is sort of what I used to do early in grad school when I was trying to get some esoteric model running in R with virtually no background knowledge. To me, vibe-coding harkens back to the days of panicked copy-and-paste from a variety Stack Overflow posts.\n\nWith this in mind, I believe in sharing my work. Here's the [full conversation](https://claude.ai/share/9ae9a888-def0-4e61-96c0-6a795d5d4ad8) I used to set up the RAG framework. I had enough of an idea of what I wanted, but wanted to speed up the code required to get the document chunking and indexing\n\n## Testing the RAG Process\n\nSo what did all that get us? Well, with the help of Claude we got a set of four functions that[^1]:\n\n[^1]: If you are curious about the full code, you can look at my prompt-testing repo under my blog posts that contains the full set\n\n1.  Extract the relevant pages from the coding manual.\n2.  Chunk up the pages into subsections based on headers.\n3.  Encode these chunks using a `SentenceTransformers` model.\n4.  Save the embedded chunks and the section indices in a vector database.\n\nas well as two others:\n\n5.  A function to query and retrieve results from the vector database.\n6.  A function to append the results into a prompt-friendly text object.\n\nI took the code and made some adjustments (maybe 10-15% or less) and then put them into their own .py file under my src folder. I then created a separate file `index_rules.py` to perform all the steps and locally store the vector database in a cache folder:\n\n::: {#5ea1d62a .cell execution_count=2}\n``` {.python .cell-code}\n\"Code to index rules from the NVDRS and store as vector store in cache\"\n\nfrom pypdf import PdfReader\nfrom src.rag import (\n    extract_pages,\n    chunk_by_subsections_with_codes,\n    encode_chunks,\n    create_vector_store,\n)\n\n# import the full nvdrs coding manual\n# we only need a subset of pages on circumstances\n# page 74 - 149\npage_min = 74\npage_max = 148\ncache_dir = \"cache/\"\n\nreader = PdfReader(\"reference/nvdrsCodingManual.pdf\")\n\n# extract pages, chunk subsections, then store in cache\n\npages_circumstances = extract_pages(reader, page_min, page_max)\nsection_circumstances = chunk_by_subsections_with_codes(pages_circumstances)\nsection_embeddings = encode_chunks(section_circumstances)\nindex, stored_chunks = create_vector_store(section_embeddings, cache_dir)\n```\n:::\n\n\nWith that done, the other adjustment I needed to make was to add the ability to query the vector database and return relevant coding rules based on matching key words in the narrative. What I did was set up a dict containing key words for each major question, and a query term to append to the retrieved text substring. So, for example, given a narrative like this:\n\n> \"Victim was at home and complained about feeling sad and depressed. Victim had been treated for ADHD and bipolar disorder and had reportedly not been taking his medications in the days preceeding\"\n\nWe would use a regex pattern to match 30 characters on either side of a matching keyword in the dict of keywords (one selected here below):\n\n::: {#f01d7f13 .cell execution_count=3}\n``` {.python .cell-code}\nkeyterms = {\n    \"DepressedMood\": {\n        \"Terms\": [\n            \"depressed\",\n            \"depressive symptoms\",\n            \"sad\",\n            \"unhappy\",\n            \"low mood\",\n            \"feeling down\",\n            \"persistent sadness\",\n            \"major depression\",\n            \"melancholy\",\n            \"hopeless\",\n            \"despair\",\n            \"gloomy\",\n            \"emotional distress\",\n            \"tearful\",\n            \"loss of interest\",\n            \"worthlessness\",\n            \"self-loathing\",\n        ],\n        \"Query\": \"Coding rules for DepressedMood\",\n    }\n```\n:::\n\n\nWe then just loop through the dict of keywords and collect all the hits.\n\nTo illustrate: passing this example narrative into our `search_vector_database` performs the steps of searching for all regex hits, encodes the matching narrative text, and then queries it against the vector database.  We take all of results from the vector database search and pass these into another function that prepares it for insertion to the prompt. The `create_prompt_rules` function adds a header for the section for coding rules, and organizes them in order of section header. The code below shows a successful retreval for the DepressedMood variable:\n\n::: {#29f63426 .cell execution_count=4}\n``` {.python .cell-code}\ntest_narrative = \"Victim was at home and complained about feeling sad and depressed. Victim had told his partner that he was thinking about taking his own life.\"\n\nval, matched_variables = search_vector_database(test_narrative, 1, \"cache/rules_index.faiss\", \"cache/rule_chunks.pkl\")\nPROMPT_RULES = create_prompt_rules(val, matched_variables)\n\nprint(PROMPT_RULES)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nIf present, use the following rules to guide your coding of variables. Closely follow these instructions:\n    - Apply ONLY the rules relevant to the question\n    - If a rule is not relevant to the question, disregard it entirely\n    - Do NOT try and apply rules to questions where they are not closely relevant\n\n\n## RULES FOR DepressedMood:\nEvidence found: \"and complained about feeling sad and depressed. Victim had tol\"\n\nRULE 1 [Section 5.3.4]:\n5.3.4 Current depressed mood: CME/LE_DepressedMood \n \nDefinition:  \nVictim was perceived by self or others to be depressed at the time of the injury. \n \nResponse Options: \n0 No, Not Available, Unknown \n1 Yes \n \nDiscussion: \nOnly code this variable when the victim had a depressed mood at the time of injury. There does NOT \nneed to be a clinical diagnosis, and there does not need to be any indication that the depression directly \ncontributed to the death. Other words that can trigger coding this variable besides “depressed” are sad, \ndespondent, down, blue, low, unhappy, etc. Words that should not trigger coding this variable are \nagitated, angry, mad, anxious, overwrought, etc. \n \n If the victim has a known clinical history of depression but had no depressive symptoms at the time \nof the incident, this variable should NOT be selected. \n Depressed mood should not be inferred by the coder based on the circumstances (e.g., because the \nperson reports a bankruptcy); rather it must be noted in the record. \n \nManner of Death: All manners.  \n \n \n\n\n\n```\n:::\n:::\n\n\n## Adding it All Together\n\nNow that I had the LLM stuff mostly incorporated, all I needed to do is append this new RAG workflow to my old LLM class. I added an extra parameter named `include_rag` that triggered the RAG process and appended it to the prompt if specified by the user:\n\n::: {#9dbf638c .cell execution_count=5}\n``` {.python .cell-code}\ndef standard_prompt_caching(\n        self,\n        header: str | list = None,\n        narrative: str | list = None,\n        body: str | list = None,\n        example_output: str | list = None,\n        footer: str | list = None,\n        include_rag: bool | list = False,\n        **kwargs\n    ) -> list:\n        \"\"\"Create multiple standard prompts based on all combinations of list elements.\n        This puts the narrative at the end to support OpenAI prompt caching.\n        \"\"\"\n\n        # Ensure all inputs are lists for consistent iteration\n        if include_rag:\n            val, matched_variables = search_vector_database(\n                narrative,\n                2,\n                \"cache/rules_index.faiss\",\n                \"cache/rule_chunks.pkl\",\n            )\n            rag = create_prompt_rules(val, matched_variables)\n            params = [body, example_output, rag, footer, header, narrative]\n        else:\n            params = [body, example_output, footer, header, narrative]\n        param_lists = [\n            [item] if not isinstance(item, list) else item for item in params\n        ]\n```\n:::\n\n\nThe final result looks like this, which is structurally almost identical to the non-RAG version I did before - in fact, the only real change is adding `include_rag = True1` to the LLM class parameters. This is all the code that processes the queries and passes them on to the OpenAI API:\n\n::: {#920df520 .cell execution_count=6}\n``` {.python .cell-code code-fold=\"true\"}\nimport pandas as pd\nimport json\nfrom datetime import datetime\n\nfrom openai import OpenAI\nfrom src.prompts import HEADER1, BODY2, EXAMPLE_OUTPUT2\nfrom src.prompt_creation import Prompt\n\nclient = OpenAI()\nrun_date = datetime.now().strftime(\"%Y-%m-%d\")\n\n# set up prompt\nprompt_creator = Prompt()\nROLE = \"\"\"You are a mental health expert reviewing law enforcement narratives of youth suicide incidents. \nYour task is to label variables relating to the incident. Closely review the following instructions. Read \nthe provided narrative and then add labels corresponding to the variables into the described JSON format. \nDo NOT deviate from the instructions. If coding rules are present you may use them to guide your analysis. \nDo NOT rely solely on the rules.\n\"\"\"\n\n# load suicide narratives and labels\nnarratives = pd.read_csv(\"data/train_narratives_sample_200.csv\")\nlabels = pd.read_csv(\"data/train_labels_sample_200.csv\")\n\n\n# Execute 1 version of prompt with RAG\njson_list = []\n\nfor row in narratives.iterrows():\n\n    # grab the unique id and text\n    single_narrative = row[1]\n    id = single_narrative[\"uid\"]\n    txt = single_narrative[\"NarrativeLE\"] + single_narrative[\"NarrativeCME\"]\n\n    prompt_input = {\n        \"header\": HEADER1,\n        \"narrative\": txt,\n        \"body\": BODY2,\n        \"example_output\": EXAMPLE_OUTPUT2,\n        \"footer\": None,\n        \"include_rag\": True\n    }\n\n    # create a prompt, pass in the text narrative\n    prompt_versions = prompt_creator.standard_prompt_caching(**prompt_input)\n\n    version_num = 0\n    for prompt in prompt_versions:\n        # now append to list\n        json_list.append(\n            {\n                \"custom_id\": f\"{id}_{version_num}\",\n                \"method\": \"POST\",\n                \"url\": \"/v1/chat/completions\",\n                \"body\": {\n                    \"model\": \"gpt-4o-mini\",\n                    \"messages\": [\n                        {\"role\": \"system\", \"content\": ROLE},\n                        {\"role\": \"user\", \"content\": prompt},\n                    ],\n                    \"max_tokens\": 500,\n                    \"response_format\": { \"type\": \"json_object\" },\n                },\n            }\n        )\n        version_num += 1\n\n\nwith open(f\"json/output_{run_date}.jsonl\", \"w\") as outfile:\n    for entry in json_list:\n        json.dump(entry, outfile)\n        outfile.write(\"\\n\")\n\n# upload batch to openai\nbatch_input_file = client.files.create(\n    file=open(f\"json/output_{run_date}.jsonl\", \"rb\"), purpose=\"batch\"\n)\n\nbatch_input_file_id = batch_input_file.id\nclient.batches.create(\n    input_file_id=batch_input_file_id,\n    endpoint=\"/v1/chat/completions\",\n    completion_window=\"24h\",\n    metadata={\"description\": \"Batch Testing 1 prompt x 200 examples with caching and RAG\"},\n)\n\n```\n:::\n\n\n### Reviewing the output\n\nFinally we can review the input and output from this. Here is the full un-edited prompt with the RAG element added. The RAG section is near the end of the prompt, just above full narrative text:\n\n*[Warning: Depictions of Self-Harm]*\n\n<details>\n<summary>Full RAG Input Prompt</summary>\n\n::: {#a6c2ad90 .cell execution_count=7}\n\n::: {.cell-output .cell-output-stdout}\n```\n\nINSTRUCTIONS:\n    Closely follow these instructions:\n        - For each variable below return a 0 for 'no' and a 1 for 'yes' unless otherwise stated.\n        - If more than two answers are available, return ONE of the numbered values.\n        - Rely ONLY on information available in the narrative. Do NOT extrapolate.\n        - Return a properly formatted json object where the keys are the variables and the values are the numeric labels.\n        - Do NOT return anything other than the label. Do NOT include any discussion or commentary.\n\nVARIABLES:   \n    DepressedMood: The person was perceived to be depressed at the time\n    - 1: Specific signs of depression were noted in the narrative (e.g., sad, withdrawn, hopeless)\n    - 0: No mention of depressive symptoms\n\n    MentalIllnessTreatmentCurrnt: Currently in treatment for a mental health or substance abuse problem\n    - 1: The person was undergoing treatment for a mental health issue at the time of the incident\n    - 0: No indication of current treatment\n\n    HistoryMentalIllnessTreatmnt: History of ever being treated for a mental health or substance abuse problem\n    - 1: Documentation of previous treatment for mental health or substance abuse is noted in the narrative\n    - 0: No prior treatment mentioned\n\n    SuicideAttemptHistory: History of attempting suicide previously\n    - 1: A past suicide attempt was mentioned\n    - 0: No documented prior attempts\n\n    SuicideThoughtHistory: History of suicidal thoughts or plans\n    - 1: Person's prior thoughts or plans of suicide were noted in the narrative\n    - 0: No history of suicidal ideation mentioned\n\n    SubstanceAbuseProblem: The person struggled with a substance abuse problem.\n    - 1: Person was noted to have issues with alcohol or drug abuse\n    - 0: No indication of substance abuse problems\n\n    MentalHealthProblem: The person had a mental health condition at the time\n    - 1: Person was noted to have a mental health condition at the time of the event\n    - 0: No documented mental health condition\n\n    DiagnosisAnxiety: The person had a medical diagnosis of anxiety\n    - 1: Person was currently, or previously, been diagnosed or treated for anxiety\n    - 0: No documented diagnosis or treatment for anxiety\n\n    DiagnosisDepressionDysthymia: The person had a medical diagnosis of depression\n    - 1: Person was currently, or previously, been diagnosed or treated for depression or dysthymia\n    - 0: No documented diagnosis or treatment for depression\n\n    DiagnosisBipolar: The person had a medical diagnosis of bipolar\n    - 1: Person was currently, or previously, been diagnosed or treated for bipolar disorder\n    - 0: No documented diagnosis or treatment for bipolar disorder\n\n    DiagnosisAdhd: The person had a medical diagnosis of ADHD\n    - 1: Person was documented as having been diagnosed or treated for ADHD\n    - 0: Person had no documentation of treatment or diagnosis for ADHD\n\n    IntimatePartnerProblem: Problems with a current or former intimate partner appear to have contributed\n    - 1: Person's relationship issues with a spouse, partner, or ex-partner were mentioned as contributing factors\n    - 0: No relationship issues were mentioned\n\n    FamilyRelationship: Relationship problems with a family member (other than an intimate partner) appear to have contributed\n    - 1: Person's conflicts with parents, siblings, children, or other family members contributed\n    - 0: No family relationship problems mentioned\n\n    Argument: An argument or conflict appears to have contributed\n    - 1: A dispute, disagreement, or verbal altercation was mentioned as a contributing factor\n    - 0: No argument or conflict mentioned\n\n    SchoolProblem: Problems at or related to school appear to have contributed\n    - 1: Issues such as academic struggles, bullying, or school disciplinary actions were noted\n    - 0: No school-related problems mentioned\n\n    RecentCriminalLegalProblem: Criminal legal problem(s) appear to have contributed\n    - 1: The person was facing legal troubles such as arrest, charges, or sentencing\n    - 0: No criminal legal issues mentioned\n\n    SuicideNote: The person left a suicide note\n    - 1: A written, digital, or verbal message was documented as a suicide note\n    - 0: No mention of a suicide note\n\n    SuicideIntentDisclosed: The person disclosed their thoughts and/or plans to die by suicide to someone else within the last month\n    - 1: Suicide intent was communicated to another person within the last month\n    - 0: No disclosure of intent mentioned\n\n    DisclosedToIntimatePartner: Intent was disclosed to a previous or current intimate partner\n    - 1: The person told a spouse or romantic partner about suicidal thoughts/plans\n    - 0: No disclosure to an intimate partner\n\n    DisclosedToOtherFamilyMember: Intent was disclosed to another family member\n    - 1: The person told a parent, sibling, child, or other relative about suicidal thoughts/plans\n    - 0: No disclosure to a family member\n\n    DisclosedToFriend: Intent was disclosed to a friend\n    - 1: The person told a friend about suicidal thoughts/plans\n    - 0: No disclosure to a friend\n\n    InjuryLocationType: The type of place where the suicide took place.\n        - 1: House, apartment\n        - 2: Motor vehicle (excluding school bus and public transportation)\n        - 3: Natural area (e.g., field, river, beaches, woods)\n        - 4: Park, playground, public use area\n        - 5: Street/road, sidewalk, alley\n        - 6: Other\n\n    WeaponType1: Type of weapon used \n        - 1: Blunt instrument\n        - 2: Drowning\n        - 3: Fall\n        - 4: Fire or burns\n        - 5: Firearm\n        - 6: Hanging, strangulation, suffocation\n        - 7: Motor vehicle including buses, motorcycles\n        - 8: Other transport vehicle, eg, trains, planes, boats\n        - 9: Poisoning\n        - 10: Sharp instrument\n        - 11: Other (e.g. taser, electrocution, nail gun)\n        - 12: Unknown\n\n\nHere is an example narrative and expected output:\n\nEXAMPLE NARRATIVE 1:\nThe V was a XX XX XX XX who died of an intentional mixed drug (fentanyl, sertraline, and amphetamine) intoxication. The V had been court ordered to admit to a addiction recovery center, and he was admitted two days ago.  He was last seen alive yesterday during room checks. He was in his room with two others. The V was found this morning unresponsive and CPR was instituted. EMS arrived and confirmed death. The V had a significant past medical history of anxiety, depression, cleft palate repair, PTSD and asthma. He reportedly had been very depressed lately and had expressed suicidal ideations including that he was going to \"take lots of pills.\" Per grandmother and mother, the V was known to take Percocet and Adderall.\n\nEXAMPLE OUTPUT 1:\n{\n    \"DepressedMood\": 1,\n    \"MentalIllnessTreatmentCurrnt\": 1,\n    \"HistoryMentalIllnessTreatmnt\": 1,\n    \"SuicideAttemptHistory\": 0,\n    \"SuicideThoughtHistory\": 1,\n    \"SubstanceAbuseProblem\": 1,\n    \"MentalHealthProblem\": 1,\n    \"DiagnosisAnxiety\": 1,\n    \"DiagnosisDepressionDysthymia\": 1,\n    \"DiagnosisBipolar\": 0,\n    \"DiagnosisAdhd\": 0,\n    \"IntimatePartnerProblem\": 0,\n    \"FamilyRelationship\": 0,\n    \"Argument\": 0,\n    \"SchoolProblem\": 0,\n    \"RecentCriminalLegalProblem\": 1,\n    \"SuicideNote\": 0,\n    \"SuicideIntentDisclosed\": 1,\n    \"DisclosedToIntimatePartner\": 0,\n    \"DisclosedToOtherFamilyMember\": 0,\n    \"DisclosedToFriend\": 0,\n    \"InjuryLocationType\": 6,\n    \"WeaponType1\": 9\n}\n\nHere is another example narrative and expected output:\n\nEXAMPLE NARRATIVE 2:\nVictim XX died of a self-intentional gunshot wound to the head, resulting in an exit wound, with a .357 caliber revolver at the victim's place of residence. The victim's ex-wife had attempted to contact the victim and had told dispatchers the victim was depressed and had thoughts of suicide. The victim left a suicide for his parents and ex-wife. Per the ex-wife, he was extremely depressed and the last text she received from him was telling her goodbye. The victim had never gotten over their divorce and struggled with depression and alcohol abuse. EMS was present and confirmed the victim deceased.\n\nEXAMPLE OUTPUT 2:\n{\n    \"DepressedMood\": 1,\n    \"MentalIllnessTreatmentCurrnt\": 0,\n    \"HistoryMentalIllnessTreatmnt\": 0,\n    \"SuicideAttemptHistory\": 1,\n    \"SuicideThoughtHistory\": 0,\n    \"SubstanceAbuseProblem\": 1,\n    \"MentalHealthProblem\": 0,\n    \"DiagnosisAnxiety\": 0,\n    \"DiagnosisDepressionDysthymia\": 0,\n    \"DiagnosisBipolar\": 0,\n    \"DiagnosisAdhd\": 0,\n    \"IntimatePartnerProblem\": 1,\n    \"FamilyRelationship\": 0,\n    \"Argument\": 0,\n    \"SchoolProblem\": 0,\n    \"RecentCriminalLegalProblem\": 0,\n    \"SuicideNote\": 1,\n    \"SuicideIntentDisclosed\": 1,\n    \"DisclosedToIntimatePartner\": 1,\n    \"DisclosedToOtherFamilyMember\": 0,\n    \"DisclosedToFriend\": 0,\n    \"InjuryLocationType\": 1,\n    \"WeaponType1\": 5\n}\n\nHere is another example narrative and expected output:\n\nEXAMPLE NARRATIVE 3:\nThis is the death of a XX XX (V). LE was dispatched at 0806 hours in reference to the V who was shot in the head. Upon arrival, the V was in an apartment with 2 other women present and a firearm. The V had a gunshot wound to the right side of the head and no exit was noted. Medics arrived and took over life saving efforts. Per the V's fiance the V suffered form anxiety and depression. The V's mood had been changing all day as he was approaching the 1 year marker of his high school friend dying by suicide. The V had been drinking throughout the day and at 2000 hours hours the V went to the park. The V was not allowed to have firearms. Prior to shooting himself the V said \"you don't think I'll do it.\" The V was transported to the hospital where he died. The firearm used was .22 caliber and a note was found that appeared to have been written by a child that read \"I love mom and dad.\" There were several gummy bears rolled up in a plastic bag with #9 written on it and a small zip lock bag with pink powder inside. There were several bottles of alcohol, THC oil and cigarette butts in the bathroom. Last year the V was committed for treatment of mental disorder.\n\nEXAMPLE OUTPUT 3:\n{\n    \"DepressedMood\": 0,\n    \"MentalIllnessTreatmentCurrnt\": 0,\n    \"HistoryMentalIllnessTreatmnt\": 1,\n    \"SuicideAttemptHistory\": 0,\n    \"SuicideThoughtHistory\": 1,\n    \"SubstanceAbuseProblem\": 1,\n    \"MentalHealthProblem\": 1,\n    \"DiagnosisAnxiety\": 1,\n    \"DiagnosisDepressionDysthymia\": 1,\n    \"DiagnosisBipolar\": 0,\n    \"DiagnosisAdhd\": 0,\n    \"IntimatePartnerProblem\": 0,\n    \"FamilyRelationship\": 0,\n    \"Argument\": 0,\n    \"SchoolProblem\": 0,\n    \"RecentCriminalLegalProblem\": 0,\n    \"SuicideNote\": 1,\n    \"SuicideIntentDisclosed\": 1,\n    \"DisclosedToIntimatePartner\": 1,\n    \"DisclosedToOtherFamilyMember\": 0,\n    \"DisclosedToFriend\": 0,\n    \"InjuryLocationType\": 1,\n    \"WeaponType1\": 5 \n}\n\n\n\nIf present, use the following rules to guide your coding of variables. Closely follow these instructions:\n    - Apply ONLY the rules relevant to the question\n    - If a rule is not relevant to the question, disregard it entirely\n    - Do NOT try and apply rules to questions where they are not closely relevant\n\n\n## RULES FOR SuicideNote:\nEvidence found: \"scovered, it appeared to be a suicide note. The v was located hanging fr\", \"home hanging from a tree.  A suicide note was found in the home.  The m\"\n\nRULE 1 [Section 5.7.6]:\n5.7.6 Left a suicide note: CME/LE_SuicideNote \n \nDefinition: \nVictim left a suicide note (or other recorded communication). Note can be written or electronic. \n \nResponse Options: \n0 No, Not Available, Unknown \n1 Yes \n \nDiscussion: \n A will or folder of financial papers near the victim does not constitute a suicide note. \n \nSection 5. Circumstances  131 | Page  \n   \n If the record states the person left a note, you can infer it was a suicide note in the absence of \ninformation indicating that the note had some other purpose. \n A suicide note can be any essentially durable message; it does not have to be on a piece of paper. \nEmails, text messages, voice mail, or writing on any object (such as a wall or table) all qualify. Phone \ncalls do not qualify, as they are not considered durable (even 911 calls, because the decedent may \nor may not have known they were being recorded). \n A suicide note does not have to communicate that the person wants or intends to die. Notes that \nare written to warn others at the scene of the fatal injury that conditions may be hazardous or \ndisturbing may be included (e.g., “Call 911, do not enter garage” or “Carbon monoxide – do not \nenter”).  \n A text or electronic message sent right before the suicide occurred should be labeled a suicide note, \nif there was no time between the sending/receipt of the message and the suicide. If there was time \nto intervene, this should be coded as “disclosed suicidal thought or intent.” If the contents of the \nsuicide note are included or described in your source documents, summarizing this information in \nthe narrative is helpful to provide further context for the incident. If you choose to do so, do not \ninclude verbatim text and do not include identifying information, but a summary of what was said. \nThis information may be helpful in noting themes related to the suicide that go beyond standard \nNVDRS circumstances and are one of the only means of accessing the decedents’ thoughts about \ntheir suicide more directly. \n \nManner of Death: Suicide and undetermined deaths. \n \n \n\n\nRULE 2 [Section 5.7.4]:\n5.7.4 Recent Disclosed Suicidal Thoughts or Intent to Die by Suicide: \nCME/LE_SuicideIntentDisclosed \n \nDefinition: Victim disclosed to another person their thoughts and/or plans to die by suicide within the \nlast month. Disclosure of suicidal thoughts or plan can be verbal, written or electronic. \n \nResponse Options: \n0 No, Not Available, Unknown \n1 Yes \n \nDiscussion:  \nThis variable helps identifies suicides for which opportunities to intervene and prevent the death may \nhave been present near the time of the suicide. It is also useful for exploring the association between \nstated intent and actual death. \n \n Code as “Yes” if the victim had disclosed suicidal thoughts or plans to another person recently or \nwithin the last month, whether explicitly (e.g., “I have been thinking about suicide lately” or “I plan \nto go to my cabin with my gun and never come back”) or indirectly (e.g., “I know how to put a \npermanent end to this pain”). Include in the narrative any available details about whom the intent \nwas disclosed to, how long before the death the intent was disclosed, and what was said during the \ndisclosure. \n Code as “Yes” if there was opportunity to intervene between the time the person disclosed intent \nand the injury event. \no Do not code this variable if the victim disclosed the intention to kill him or herself only at the \nmoment of the suicide (i.e., when there was no opportunity to intervene to stop the \nsuicide). For instance, sending an email or text message right before the victim shot herself. \nThis would be considered a suicide note. \n Do not endorse this variable if the victim had talked about suicide sometime in the distant past but \nhad not recently disclosed a current intent to die by suicide to anyone. This would be coded as \n“History of disclosed suicidal thoughts/plans”. \n A separate suicide attempt by the victim within a month of the suicide should be coded as “Yes.” In \nthis case, “History of suicide attempts” should also be coded, “Yes.” \n The timing of when the victim disclosed the suicidal intent may be unclear (e.g., recently or some \ntime ago) or not mentioned. Please use the following rules to code these cases: \no Code “Yes” if the narrative states the victim “just” or “recently” told someone about his \nsuicidal intent. \no If the record indicates disclosure of intent, but is unclear about the timeframe (i.e., does not \nmention it all), code as “Yes.” \no LE or C/ME reports may be unclear about timing of the disclosure. If the record indicates \ndisclosure of intent in the past, but states that there was no disclosure for the current \nincident, do not code, instead use the “History of suicidal thoughts/plan/attempts.” \no If the victim disclosed suicidal intent “a long time ago,” “more than a month ago,” or in the \n \nSection 5. Circumstances  130 | Page  \n   \n“past,” code as “No” and code “History of disclosed suicidal thought/plans/actions.” \n \nManner of Death: Suicide and undetermined deaths.  \n \n \n\n\n\n\n## RULES FOR DiagnosisAnxiety:\nEvidence found: \"ffered from depression, ADHD, PTSD, school problems and legal pr\", \"an undiagnosed and untreated PTSD.  The decedent had witnessed\"\n\nRULE 1 [Section 5.3.3]:\n5.3.3 Mental Health Diagnosis Variables \n5.3.3.1. Mental health diagnosis 1: CME/LE_MentalHealthDiagnosis1 \n5.3.3.2. Mental health diagnosis 2: CME/LE_MentalHealthDiagnosis2 \n5.3.3.3. Other mental health diagnosis: CME/LE_MentalHealthDiagnosisOther \n \nDefinitions: \n CME/LE_MentalHealthDiagnosis1/2: Type of mental illness diagnosis \n CME/LE_MentalHealthDiagnosisOther: Other type of mental illness \n \nResponse Options: \n CME/LE_MentalHealthDiagnosis1/2  \n1 Depression/dysthymia \n2 Bipolar disorder \n3 Schizophrenia \n4 Anxiety disorder \n5 Post-traumatic stress disorder \n6 Attention Deficit/Hyperactivity Disorder (ADHD) \n7 Eating disorder \n8 Obsessive- compulsive disorder \n9 Autism Spectrum (including Asperger’s Syndrome) \n10 Fetal Alcohol Syndrome \n11 Down Syndrome \n12 Dementia (e.g., Alzheimer’s disease, Lewy Body Dementia) \n66 Other (specify in diagnosis text), including personality disorders, etc. \n88 Not applicable \n99 Unknown \n \n CME/LE_MentalHealthDiagnosisOther  \nText \n \nDiscussion:  \nThis variable indicates the nature of the victim’s mental health problem (the diagnosis), if available. \n \n Code up to two diagnoses and then write in additional diagnoses (i.e., three or more diagnoses) in \nthe “MentalHealthDiagnosisOther” field. When using the “MentalHealthDiagnosisOther” field, \nplease separate diagnoses with a comma (e.g., antisocial personality disorder, narcissistic \npersonality disorder). \n For cases in which the victim was noted as being treated for a mental health problem, but the actual \ndiagnosis is not documented, code “MentalHealthDiagnosis1” as “Unknown.” \n \nSection 5. Circumstances  82 | Page  \n   \n If a diagnosis is not on the code list, code “Other” and record the diagnosis in the text field, \n“MentalHealthDiagnosisOther.” \n Do not attempt to infer a diagnosis based on reading the symptoms. \n While it is acceptable to endorse “Mental health problem” based on the victim’s prescription for a \npsychiatric medication, please do not infer or code a specific mental health diagnosis based on the \nmedication. \n Please note that bipolar disorder may be referred to as “manic depression” or similar terms (e.g., \n“manic depressive”) in source documents. While these are outdated terms, please code these cases \nas “2 – Bipolar Disorder.” \n Obsessive compulsive disorder may be referred to as “OCD” in source documents. Please code these \ncases as “8 – Obsessive Compulsive Disorder.” \n Post-traumatic stress disorder may be referred to as “PTSD” in source documents. Please code these \ncases as “5 – Post-traumatic Stress Disorder.”  \n \nManner of Death: All manners.  \n \n \n\n\nRULE 2 [Section 5.3.1]:\n5.3.1 Current diagnosed mental health problem: CME/LE_MentalHealthProblem \n \nDefinition:  \nCurrent mental health problem \n \nResponse Options: \n0 No, Not Available, Unknown \n1 Yes \n \nDiscussion: \nCode a victim as “Yes” for “C/ME/LE_MentalHealthProblem” if he or she has been identified as currently \nhaving a mental health problem. There does not need to be any indication that the mental health \ncondition directly contributed to the death. \n \n Mental health problems include those disorders and syndromes listed in the Diagnostic and \nStatistical Manual of Mental Disorders, Fifth Edition (DSM-5) with the exception of alcohol and other \nsubstance dependence (as these are captured in separate variables). \n Examples of disorders qualifying as mental health problems include diagnoses such as major \ndepression, schizophrenia, and generalized anxiety disorder, as well as neurodevelopmental \ndisorders (such as intellectual disability, autism, attention-deficit /hyperactivity disorder), eating \ndisorders, personality disorders, and organic mental disorders (such as Alzheimer’s and other \ndementias). \n Also indicate “Yes” if it is mentioned in the source document that the victim was being treated for a \nmental health problem, even if the nature of the problem is unclear (e.g., “was being treated for \nvarious psychiatric problems”). \n It is acceptable to endorse this variable on the basis of past treatment of a mental health problem, \nunless it is specifically noted that the past problem has been resolved. However, do not code this \ncircumstance based only on a positive toxicology test for psychiatric medications (such as \nantidepressants). There must also be some indication that the victim was actually being treated for a \nmental health condition, such as a current prescription, the report of a family member, etc. \n  \nAlso code: At least one Mental Health Diagnosis variable should also be coded if this is coded. If the type \nof mental health diagnosis is unknown, please code “Type of first mental illness diagnosed” as “99 –\nUnknown.”  \n \nManner of Death: All manners. \n  \n \n\n\n\n\n## RULES FOR DiagnosisAdhd:\nEvidence found: \"he suffered from depression, ADHD, PTSD, school problems and le\"\n\nRULE 1 [Section 5.3.3]:\n5.3.3 Mental Health Diagnosis Variables \n5.3.3.1. Mental health diagnosis 1: CME/LE_MentalHealthDiagnosis1 \n5.3.3.2. Mental health diagnosis 2: CME/LE_MentalHealthDiagnosis2 \n5.3.3.3. Other mental health diagnosis: CME/LE_MentalHealthDiagnosisOther \n \nDefinitions: \n CME/LE_MentalHealthDiagnosis1/2: Type of mental illness diagnosis \n CME/LE_MentalHealthDiagnosisOther: Other type of mental illness \n \nResponse Options: \n CME/LE_MentalHealthDiagnosis1/2  \n1 Depression/dysthymia \n2 Bipolar disorder \n3 Schizophrenia \n4 Anxiety disorder \n5 Post-traumatic stress disorder \n6 Attention Deficit/Hyperactivity Disorder (ADHD) \n7 Eating disorder \n8 Obsessive- compulsive disorder \n9 Autism Spectrum (including Asperger’s Syndrome) \n10 Fetal Alcohol Syndrome \n11 Down Syndrome \n12 Dementia (e.g., Alzheimer’s disease, Lewy Body Dementia) \n66 Other (specify in diagnosis text), including personality disorders, etc. \n88 Not applicable \n99 Unknown \n \n CME/LE_MentalHealthDiagnosisOther  \nText \n \nDiscussion:  \nThis variable indicates the nature of the victim’s mental health problem (the diagnosis), if available. \n \n Code up to two diagnoses and then write in additional diagnoses (i.e., three or more diagnoses) in \nthe “MentalHealthDiagnosisOther” field. When using the “MentalHealthDiagnosisOther” field, \nplease separate diagnoses with a comma (e.g., antisocial personality disorder, narcissistic \npersonality disorder). \n For cases in which the victim was noted as being treated for a mental health problem, but the actual \ndiagnosis is not documented, code “MentalHealthDiagnosis1” as “Unknown.” \n \nSection 5. Circumstances  82 | Page  \n   \n If a diagnosis is not on the code list, code “Other” and record the diagnosis in the text field, \n“MentalHealthDiagnosisOther.” \n Do not attempt to infer a diagnosis based on reading the symptoms. \n While it is acceptable to endorse “Mental health problem” based on the victim’s prescription for a \npsychiatric medication, please do not infer or code a specific mental health diagnosis based on the \nmedication. \n Please note that bipolar disorder may be referred to as “manic depression” or similar terms (e.g., \n“manic depressive”) in source documents. While these are outdated terms, please code these cases \nas “2 – Bipolar Disorder.” \n Obsessive compulsive disorder may be referred to as “OCD” in source documents. Please code these \ncases as “8 – Obsessive Compulsive Disorder.” \n Post-traumatic stress disorder may be referred to as “PTSD” in source documents. Please code these \ncases as “5 – Post-traumatic Stress Disorder.”  \n \nManner of Death: All manners.  \n \n \n\n\nRULE 2 [Section 5.1.2]:\n5.1.2 Coding Mental Health, Alcohol and Substance Abuse Problems \nAbstractors should code circumstances related to mental health, alcohol or substance abuse problems, \nor other addictions as “Yes” if any of these problems are indicated in investigation reports. A direct link \nto the death is not required. These circumstances are coded for all victims. \n \n \n\n\n\n\n## RULES FOR DepressedMood:\nEvidence found: \"h his girlfriend and was very depressed the evening before, the V's r\"\n\nRULE 1 [Section 5.3.4]:\n5.3.4 Current depressed mood: CME/LE_DepressedMood \n \nDefinition:  \nVictim was perceived by self or others to be depressed at the time of the injury. \n \nResponse Options: \n0 No, Not Available, Unknown \n1 Yes \n \nDiscussion: \nOnly code this variable when the victim had a depressed mood at the time of injury. There does NOT \nneed to be a clinical diagnosis, and there does not need to be any indication that the depression directly \ncontributed to the death. Other words that can trigger coding this variable besides “depressed” are sad, \ndespondent, down, blue, low, unhappy, etc. Words that should not trigger coding this variable are \nagitated, angry, mad, anxious, overwrought, etc. \n \n If the victim has a known clinical history of depression but had no depressive symptoms at the time \nof the incident, this variable should NOT be selected. \n Depressed mood should not be inferred by the coder based on the circumstances (e.g., because the \nperson reports a bankruptcy); rather it must be noted in the record. \n \nManner of Death: All manners.  \n \n \n\n\nRULE 2 [Section 5.7.1]:\n5.7.1 History of suicidal thoughts or plans: CME/LE_SuicideThoughtHistory \n \nDefinition:  \nVictim had a history of suicidal thoughts or plans. Disclosure of suicidal thoughts or plan can be verbal, \nwritten or electronic. \n \nResponse Options: \n0 No, Not Available, Unknown \n1 Yes \n \nDiscussion:  \nUse this code for victims who have at any time in their life expressed suicidal thoughts or plans. The \nvictim may or may not have disclosed suicidal thoughts and/or plans close to the time of the suicide. \n \n Suicidal ideation can be expressed directly (e.g., “I am thinking of killing myself”) or indirectly (e.g., “I \ndon’t know if I want to go on living”). \n When the timing is unclear (e.g., timing not mentioned) or if the suicidal thoughts were described as \noccurring in the “past,” “a few years ago,” or “just,” history of suicidal thoughts should be “Yes.” \n Also code “Recently disclosed suicidal thoughts/plans” in addition to this item, if the victim disclosed \nsuicidal thoughts and/or plans close to the time (within one month) of the suicide.”   \n Code “No” for previous suicide attempts if the victim did not disclose suicidal thoughts or plans. \nPrevious suicide attempts should be coded as “History of Suicide Attempts.” \n \nNote: This variable was added in August 2013.  \n \nManner of Death: Suicide and undetermined deaths.  \n \n \n\n\n\nCarefully read the following law enforcement narrative:\nThe V, an XX XX, was discovered by police hanging in a wooded area, 911 was called. EMS arrived and declared the V dead at the scene. The V had recently broken up with his girlfriend and was very depressed the evening before, the V's roommate was concerned the V was suicidal. The ex-girlfriend stated she was speaking with the V on the phone and he made suicidal statements to her, while talking to the V the ex-girlfriend heard a loud noise in the background and the phone went dead, she then contacted 911. Police were contacted and they made a welfare check and was unable to reach the V at his residence. While speaking to the V's roommate the police started to search on a wooded path behind his residence. A handwritten note was discovered, it appeared to be a suicide note. The v was located hanging from one of the trees just off path.The V, a XX XX, died from asphyxia due to hanging.  The decedent was found during a welfare check requested by his ex-girlfriend.  The ex-girlfriend reported he had called her and told her \"he was going to kill himself\" and then she heard a loud noise.  She arrived at his home and his gun was missing so she assumed he shot himself.  He was found in the woods behind his home hanging from a tree.  A suicide note was found in the home.  The mother reported he suffered from depression, ADHD, PTSD, school problems and legal problems.  The mother reported an undiagnosed and untreated PTSD.  The decedent had witnessed his friend shot in front of him.  Since then he had \"gone down the wrong path\".  He struggled with alcohol and drugs.  The mother reported he was trying to turn his life around after the birth of his child, but was denied visitation rights due to his legal troubles.\n\n```\n:::\n:::\n\n\n</details>\n\nAnd the output:\n\n<details>\n<summary>JSON Output</summary>\n\n::: {#e67321de .cell execution_count=8}\n\n::: {.cell-output .cell-output-stdout}\n```\n{\n    \"DepressedMood\": 1,\n    \"MentalIllnessTreatmentCurrnt\": 0,\n    \"HistoryMentalIllnessTreatmnt\": 1,\n    \"SuicideAttemptHistory\": 0,\n    \"SuicideThoughtHistory\": 1,\n    \"SubstanceAbuseProblem\": 1,\n    \"MentalHealthProblem\": 1,\n    \"DiagnosisAnxiety\": 0,\n    \"DiagnosisDepressionDysthymia\": 1,\n    \"DiagnosisBipolar\": 0,\n    \"DiagnosisAdhd\": 1,\n    \"IntimatePartnerProblem\": 1,\n    \"FamilyRelationship\": 0,\n    \"Argument\": 0,\n    \"SchoolProblem\": 0,\n    \"RecentCriminalLegalProblem\": 1,\n    \"SuicideNote\": 1,\n    \"SuicideIntentDisclosed\": 1,\n    \"DisclosedToIntimatePartner\": 1,\n    \"DisclosedToOtherFamilyMember\": 0,\n    \"DisclosedToFriend\": 0,\n    \"InjuryLocationType\": 3,\n    \"WeaponType1\": 6\n}\n```\n:::\n:::\n\n\n</details>\n\nI didn't ask for any reasoning or citations for the rules provided. Here I just wanted the raw JSON output - but it would be trivial to add another section and ask for specific citations when the rules provided were applied.\n\n## My Take\n\nTo be honest, I was surprised that most of the Claude-generated code worked as well as it did. I had to make few substantial changes. The code to do the chunking, embedding, and indexing took maybe under 30 minutes for me to read through, edit slightly, and execute. Adding these functions into my existing workflow took under and hour - so maybe 90 minutes total from prompt to working RAG proof-of-concept. To be honest, totally wild. I could have figured this out on my own, but this was like half a day of work, compared to the week it would take me to do it solely by scratch.\n\nHere's the rub - I think \"vibe coding\" can be helpful to jumpstart a project from nothing to a workable proof-of-concept. I do NOT think it is a good idea to rely 100% on AI-generated code without knowing what it is actually doing. Personally, I think its a good idea to get a working POC and then pick apart all of the functions and steps the LLM generated to understand whats happening. Blind coding can certainly be a \"vibe\" but I don't think it is sustainable for real-world production-level code.\n\n",
    "supporting": [
      "vibe-coding_files"
    ],
    "filters": [],
    "includes": {}
  }
}