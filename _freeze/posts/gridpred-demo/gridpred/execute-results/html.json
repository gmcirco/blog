{
  "hash": "2de0bb8bc14d96dc545fb634ff06e573",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Introducing 'GridPred'\"\nsubtitle: \"Spatial grid prediction using machine learning models\"\nauthor: Gio Circo, Ph.D.\ndate: 2026-01-11\ncategories:\n  - Python\n  - Data Science Applications\nbibliography: refs.bib\nformat: \n  html:\n    self-contained: true\n    code-fold: false\n    mainfont: \"Roboto\"\n    section-divs: true\n    toc: true\n    title-block-banner: true\n    mermaid:\n      theme: neutral\ntheme: flatly\nimage: map.png\n---\n\n\n## Spatial Crime Prediction Models\n\nThere are no shortage of crime prediction models available today. In fact, [stuff]\n\nMy goal for this project was to put together a fairly simple, minimal, and effective workflow for setting up disparate sets of data into something that can be used in a machine learning model (a sort of plug-and-play model). I wanted to avoid overt complexity, because there is ample research that prior crime counts are often the best predictor of future crime events[@gorr2003short]. The actual described workflow below is, in fact, inspired by earlier work that was demonstrated in Dallas[@wheeler2021mapping].\n\n## Working with `GridPred`\n\nWith this in mind, To this end, the absolute minimal set of functions `GridPred` does is create a spatial grid over a set of input points (like crime), split them into a training and evaluation set, and allows you to pass them into a machine learning model. For a lot of use cases, this might get you 80 - 90% there.\n\nBelow, we import the key modules and define define the inputs. The key functions are all contained under the core `GridPred` class under `gridpred.prediction`. The library optionally contains a number of helper functions to aid with model fitting, visualization, and metrics calculations.\n\nFor importing, at a minimum you need to provide either a pandas dataframe or csv file containing a longitudinal set of crime data with a date field and longitude and latitude fields:\n\n::: {#f85ef940 .cell execution_count=2}\n``` {.python .cell-code code-fold=\"show\"}\n# import all relevant functions\nimport pandas as pd\nimport numpy as np\nfrom gridpred.evaluate.metrics import evaluate, pai, pei, rri\nfrom gridpred.model.random_forest import RandomForestGridPred\nfrom gridpred.plotting import visualize_predictions\nfrom gridpred.prediction import GridPred\n\n# inputs\ncrime_data = \"input/hartford_robberies.csv\"\npredictor_features = \"input/hartford_pois.csv\"\nregion_shapefile = \"input/hartford.shp\"\n```\n:::\n\n\nIf possible, you should also provide additional predictor features in the same format as the input crime data. If you have a shapefile that marks the boundry of your study area, you can pass that as well to make sure the metrics calculated correspond strictly to the region's boundaries.\n\n::: {#9e6a84d6 .cell execution_count=3}\n``` {.python .cell-code code-fold=\"show\"}\n# define variable names\ntime_var = \"year\"\nfeatures_var = \"types\"\n\n# spatial projections\n# includes the coordinate reference system of the input crime data\n# as well as a desired projection for all spatial objects\ninput_crime_crs = 3508\nprojected_crs = 3508\n\n# size of the grid to use (in units based on projection)\ngrid_size = 400\n\n\n# This initalizes the GridPred class with the specified data\ngridpred = GridPred(\n    input_crime_data=crime_data,\n    input_features_data=predictor_features,\n    input_study_region=region_shapefile,\n    crime_time_variable=time_var,\n    features_names_variable=features_var,\n    input_crs=input_crime_crs,\n)\n```\n:::\n\n\nThe `prepare_data` function takes all of our inputs and creates a tabular dataset `X` that can be used in a prediction model. Printing the object below shows that we have the counts of 2017 robberies, as well as the nearest distance to a variety of potentially criminogenic features (gas stations, bars, night clubs, etc...). `y` is the hold-out evaluation set (by default, it is the most recent time value)\n\n::: {#afc98418 .cell execution_count=4}\n``` {.python .cell-code}\n# This generates the input to the regression model\ngridpred.prepare_data(\n    grid_cell_size=grid_size,\n    do_projection=True,\n    projected_crs=projected_crs\n)\n\n# Look at top 5 values in the predictor matrix\n# is stored as a class object `X`\ngridpred.X.head(5).round(2)\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>events_2017</th>\n      <th>liquor_store</th>\n      <th>bar</th>\n      <th>gas_station</th>\n      <th>restaurant</th>\n      <th>pharmacy</th>\n      <th>night_club</th>\n      <th>x</th>\n      <th>y</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>231</th>\n      <td>0</td>\n      <td>641.01</td>\n      <td>648.26</td>\n      <td>2878.30</td>\n      <td>4489.75</td>\n      <td>5964.84</td>\n      <td>9438.41</td>\n      <td>1010113.10</td>\n      <td>824653.91</td>\n    </tr>\n    <tr>\n      <th>308</th>\n      <td>0</td>\n      <td>254.13</td>\n      <td>255.45</td>\n      <td>2915.07</td>\n      <td>4217.04</td>\n      <td>5942.46</td>\n      <td>9098.14</td>\n      <td>1010511.83</td>\n      <td>824679.61</td>\n    </tr>\n    <tr>\n      <th>154</th>\n      <td>0</td>\n      <td>970.47</td>\n      <td>979.03</td>\n      <td>2892.32</td>\n      <td>4732.11</td>\n      <td>6006.24</td>\n      <td>9726.21</td>\n      <td>1009781.55</td>\n      <td>824629.96</td>\n    </tr>\n    <tr>\n      <th>232</th>\n      <td>0</td>\n      <td>751.07</td>\n      <td>744.97</td>\n      <td>2534.31</td>\n      <td>4231.56</td>\n      <td>5618.71</td>\n      <td>9241.02</td>\n      <td>1010119.00</td>\n      <td>825000.00</td>\n    </tr>\n    <tr>\n      <th>309</th>\n      <td>0</td>\n      <td>467.13</td>\n      <td>449.17</td>\n      <td>2605.54</td>\n      <td>3962.67</td>\n      <td>5622.69</td>\n      <td>8907.88</td>\n      <td>1010519.00</td>\n      <td>825000.00</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nBy default, when creating the predictor dataset, `GridPred` sets aside $t-2$ as the outcome for training the model, and $t-1$ for evaluation. All remaining time periods are used as count features in the model.\n\n### Predictor Models\n\nFor the actual modelling portion, users can specify *any* model that accepts a tabular input format. For simplicity we can just use a `RandomForestGridPred` which is primarily a wrapper around a `scikit-learn` Random Forest model with some convience functions added on top. But you could just as easily import any other model and run them separately.\n\n::: {#c7e85768 .cell execution_count=5}\n``` {.python .cell-code}\n# very basic demo model workflow\n# can replace with xgboost or whatever model\nX = gridpred.X\ny = gridpred.y\n\nrf = RandomForestGridPred(\n    n_estimators=500, criterion=\"poisson\", random_state=42\n)\nrf.fit(X, y)\ny_pred = rf.predict(X)\n```\n:::\n\n\n::: {#ae5fecba .cell execution_count=6}\n``` {.python .cell-code}\n# print feature importances\n# TODO: in future, can be logged and plotted\nimportances = pd.Series(rf.get_feature_importances(), index=X.columns)\nprint(importances.sort_values(ascending=False))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nevents_2017     0.270618\nliquor_store    0.240522\npharmacy        0.089078\nrestaurant      0.084547\ngas_station     0.081187\nnight_club      0.072135\nbar             0.071431\ny               0.053238\nx               0.037243\ndtype: float64\n```\n:::\n:::\n\n\n::: {#27d80139 .cell execution_count=7}\n``` {.python .cell-code}\n# plotting\nregion_grid = gridpred.region_grid\nvisualize_predictions(region_grid, y_pred)\n```\n\n::: {.cell-output .cell-output-display}\n![](gridpred_files/figure-html/cell-8-output-1.png){width=607 height=781}\n:::\n:::\n\n\n### Evaluation Metrics\n\nWe can compute a number of standard crime-prediction metrics like the Predictive Accuracy Index (PAI), the Predective Effecicency Index (PEI), and the Rate Recapture Index (RRI) which are already pre-defined in the library. You can pass in a dict of metrics or a simple list of the functions on their own.\n\nFurthermore, you can pass any valid function to `evaluate`. You can also define any other arbitrary set of functions as long as it takes the values `y_true` and `y_pred` as an argument. An example below shows a custom function defined for computing the hit rate (proportion of total crimes in the top x% of predicted hot spots).\n\n::: {#623ce948 .cell execution_count=8}\n``` {.python .cell-code}\n# Pass a dict of pre-defined library metrics\nMETRICS = {'PAI': pai, 'PEI': pei, 'RRI': rri}\n\nprint(\n    evaluate(\n        y_true=gridpred.eval,\n        y_pred=y_pred,\n        metrics=METRICS,\n        region_grid=region_grid,\n        round_digits=2\n    )\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n{'PAI': 14.21, 'PEI': 0.49, 'RRI': 14.96}\n```\n:::\n:::\n\n\nYou can also define any other kind of metric you want. For example, here's one where we define a hit rate function (proportion of all crimes in hot spot areas).\n\n::: {#40890ebe .cell execution_count=9}\n``` {.python .cell-code}\n# function for hit rate, add to dict and evaluate alongside others\ndef hit_rate(y_true, y_pred, top_fraction=0.01, **kwargs):\n\n    # ensure arrays\n    y_true = y_true.values\n    k = int(np.ceil(len(y_pred) * top_fraction))\n\n    # top predicted cells\n    idx = np.argsort(y_pred)[-k:]\n\n    return y_true[idx].sum() / y_true.sum() if y_true.sum() > 0 else 0.0\n```\n:::\n\n\n::: {#e1897cd4 .cell execution_count=10}\n``` {.python .cell-code}\nprint(\n    evaluate(\n        y_true=gridpred.eval,\n        y_pred=y_pred,\n        metrics=[pai, hit_rate],\n        region_grid=region_grid,\n        round_digits=2,\n    )\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n{'pai': 14.21, 'hit_rate': 0.15}\n```\n:::\n:::\n\n\n",
    "supporting": [
      "gridpred_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}