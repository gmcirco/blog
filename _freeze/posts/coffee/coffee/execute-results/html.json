{
  "hash": "209f3b71ab043c91b74b326d4b6867d2",
  "result": {
    "markdown": "---\ntitle: \"The Great American Coffee Taste Test\"\nsubtitle: \"A deeper dive with Bayes\"\nauthor: \"Gio Circo, Ph.D.\"\ndate: 2023-12-01\nformat: \n    html:\n        self-contained: false\n        code-fold: true\n        mainfont: \"Roboto\"\n        section-divs: true\n        toc: true\n        title-block-banner: true\ncategories:\n  - R\n  - Bayesian Statistics\ntheme: flatly\nimage: \"coffee.jpg\"\n---\n\n::: {.cell}\n\n:::\n\n\n## The Great American Coffee Taste Test\n\nIn October I was lucky enough to participate in popular coffee YouTuber James Hoffman's [Great American Coffee Taste Test](https://cometeer.com/pages/the-great-american-coffee-taste-test). In short, participants got 4 samples of coffee and were able to brew, taste, and rate them live. One the interesting parts of this was that the data was freely shared after the tasting was completed. As both a data and coffee nerd, I couldn't resit a dive into this dataset.\n\nThe one we're going to focus on is the unusual [**Coffee 'D'**](https://youtu.be/bMOOQfeloH0?si=E9xaNcI-JBsR8-Yw&t=422). In contrast to the other coffees in the taste test, Coffee 'D' was a natural process. The difference between a washed coffee and natural coffee is:\n\n>Washed coffee and natural process coffee differ primarily in their processing methods. Washed coffee involves removing the outer fruit from the coffee bean before drying, using water to ferment and wash away the pulp, resulting in a clean, bright flavor profile with pronounced acidity. In contrast, natural process coffee involves drying the whole coffee cherry intact, allowing the bean to ferment inside the fruit, imparting a fruitier, sometimes wine-like, sweetness with a heavier body due to prolonged contact with the fruit, often exhibiting complex, earthy, or fermented flavor notes. These distinct processes significantly influence the taste and characteristics of the final brew, offering a spectrum of flavors to coffee enthusiasts.\n\nThe tl;dr is that natural process coffees tend to have more fermented, fruity flavors that are prized by some consumers, but often disliked by others. This is the one we're going to focus our attention on here. \n\n### The survey\n\nWhile there were numerous questions on the [survey](https://tally.so/r/wzy48M), my focus was primarily on the following:\n\n- Age\n- Gender\n- Self-rated coffee expertise\n\nI categorized ages into groups (`18-24`, `25-34`, `35-44`, `45-54`, and `55+`), and gender into `(Male`, `Female`). The self-rated coffee expertise was on a scale from 1 to 10, with 1 representing *\"I'm a novice\"* and 10 representing *\"I'm a coffee expert.\"*\n\nInitially, we need to convert the survey data from a wide format to a long one. In the current data view, each person's response is repeated four times (once for each coffee type), while their age, gender, and self-reported coffee expertise remain constant. This approach allows us to model responses more efficiently and retain information across different coffee types.\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> age </th>\n   <th style=\"text-align:left;\"> gender </th>\n   <th style=\"text-align:right;\"> expertise </th>\n   <th style=\"text-align:left;\"> coffee </th>\n   <th style=\"text-align:right;\"> ranking </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 18-24 </td>\n   <td style=\"text-align:left;\"> Other (please specify) </td>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> pref_a </td>\n   <td style=\"text-align:right;\"> 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 18-24 </td>\n   <td style=\"text-align:left;\"> Other (please specify) </td>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> pref_b </td>\n   <td style=\"text-align:right;\"> 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 18-24 </td>\n   <td style=\"text-align:left;\"> Other (please specify) </td>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> pref_c </td>\n   <td style=\"text-align:right;\"> 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 18-24 </td>\n   <td style=\"text-align:left;\"> Other (please specify) </td>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> pref_d </td>\n   <td style=\"text-align:right;\"> 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 55+ </td>\n   <td style=\"text-align:left;\"> Not Provided </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> pref_a </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 55+ </td>\n   <td style=\"text-align:left;\"> Not Provided </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> pref_b </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 55+ </td>\n   <td style=\"text-align:left;\"> Not Provided </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> pref_c </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 55+ </td>\n   <td style=\"text-align:left;\"> Not Provided </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> pref_d </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 25-34 </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:left;\"> pref_a </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 25-34 </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:left;\"> pref_b </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Fitting A Bayesian Model\n\nWe're employing an ordinal regression model with a cumulative link function, which is a typical method for analyzing Likert-style data. Gender remains constant across all coffee categories, while we permit the effects of age and expertise to differ for each type of coffee. Essentially, this suggests that we assume broader gender differences for all coffees, while acknowledging that the effects of age and expertise may differ across various coffee types.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\n# set reasonable priors\nprior <- c(prior(normal(0,2), class = Intercept),\n           prior(normal(0,2), class = b),\n           prior(normal(0,2), class = sd))\n\n# hlm with varying slopes for expertise\n# and varying intercepts for age\nfit2 <-\n  brm(\n    ranking ~ 1 + \n      gender +\n      (age + expertise | coffee),\n    data = coffee_ranking,\n    prior = prior,\n    family = cumulative(\"probit\"),\n    chains = 4,\n    cores = 4,\n    iter = 2000,\n    control = list(adapt_delta = 0.9)\n  )\n```\n:::\n\n\nThere are a few divergent transitions after fitting, but that can be fixed by upping the `adapt_delta` parameter. In general I'm satisfied with the fit, as all of our `Rhat` values are equal to 1.00, and the `Bulk_ESS` and `Tail_ESS` look fine too.\n\nAfter fitting the model, we can get some initial insights by plotting out some of the model coefficients. Specifically, we probably want to focus our attention on the varying effects for age and expertise on coffee preferences. We can do this by extracting the random effects from the model and plotting them. Here, we can see the estimated effect of age on preferences for each coffee (relative to the 18-24 group).\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Effect of age on coffee preferences. Older individuals tend to rate coffee D lower.](coffee_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n...and the effect of self-reported expertise:\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Effect of expertise on coffee preferences. Individuals with higher expertise tend to rate coffee 'A' and 'D' higher.](coffee_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nFrom this we see results that largely fit with what was reported in the video. Older people tend to dislike Coffee 'A' and 'D' more, and people with higher expertise tend to like them more. \n\n### Digging a little deeper: Males vs. Females\n\nLet's start by looking at *all* the predicted rankings for coffee 'D'. In this case we have 500 different predictions, corresponding to all possible age x gender x expertise x ranking combinations. Each individual line represents the estimated ranking for a particular consumer. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![Predictions for all consumer groups. Each line represents a single age, gender, and expertise combination.](coffee_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nUsing this data we can do some simple comparisons. For example: what is the estimated difference between males and females ranking coffee 'D'? In his summary, James Hoffman highlighted that [females were much more likely](https://youtu.be/bMOOQfeloH0?si=Nljr4mcZoLswoW0p&t=479) to strongly dislike coffee 'D' relative to males. However, if you look at the data, females in the survey also generally reported much less expertise in coffee.\n\nSo what if we control for expertise, and see what the estimated difference in gender is assuming they are otherwise comparable coffee consumers. Below, we set the expertise for predictions to the median, which is 6.\n\n::: {#fig-elephants layout-ncol=2}\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](coffee_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](coffee_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nCoffee rankings for males and females, across all age groups\n:::\n\nAnd here are the estimates for males and females, holding age constant at 25-34 and self-reported expertise to the median (6). As we can see both males and females with similar expertise within the same age groups largely rate coffee D similarly, with the largest difference being for ranking it a 5.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Effect of gender on preferences for coffee 'D' holding age constant to 25-34.](coffee_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nSo really, there aren't very large difference in regards to gender after we control for expertise. The large gender difference that James sees in the survey is likely mostly an artifact of differences in experience with coffee between males and females^[Given the viewership demographics for James' channel, I actually assume that many of the female ratings are the partners of the male viewers, and are probably not as experienced as their partners]. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![Female respondents were less likely to report high expertise with coffee, relative to males.](coffee_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nIn fact, if we look at the differences in self-reported expertise we have estimated rankings for a male, aged 25-34 for self-reported expertise at 1, 5, and 10. As is fairly clear, the distribution of estimated rankings is *substantially* different across levels of expertise. For example, we estimate about an 80% probability that a person with a self-assessed expertise of 10 to rate coffee 'D' a 4 or 5. In contrast that drops to about 45% for a person with an expertise of 5, and 20% for a person with an expertise of 1.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Effect of expertise on preferences for coffee 'D' holding age and gender constant to 25-34 and male. Persons with higher coffee expertise are more likely to rate coffee 'D' higher.](coffee_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\nIf it's not already clear, the biggest differences in rating the unusual natural-process coffee is not really related to gender, but rather it is mostly based on an individuals expertise or 'expertise' with coffee. \n\n## Comparing two hypothetical consumers\n\nSo now that we have our model, we can use it to pose any number of comparisons by relying on posterior draws. \n\nLet's first look at the most common age-gender-expertise combinations. Below we see that males largely make up the most common individuals who completed the survey. From a hypothetical perspective, let's compare how the most common male respondent (between 25-34 years old with an expertise of 7) would rate a given coffee compared to the most common female respondent (25-34 with an expertise of 5).\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoffee_data %>%\n  count(age,gender,expertise) %>%\n  arrange(desc(n)) %>%\n  slice(1:10) %>%\n  kable()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> age </th>\n   <th style=\"text-align:left;\"> gender </th>\n   <th style=\"text-align:right;\"> expertise </th>\n   <th style=\"text-align:right;\"> n </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 25-34 years old </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 383 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 25-34 years old </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 305 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 25-34 years old </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 199 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 35-44 years old </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 168 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 25-34 years old </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 159 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 35-44 years old </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 159 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 35-44 years old </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 114 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 25-34 years old </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 84 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 25-34 years old </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 81 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 25-34 years old </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 80 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nFirst we need to compute 4000 posterior draws for each hypothetical user. These will be probabilities for our hypothetical person scoring a given coffee a 1 though a 5. We can get this by calling the `posterior_epred` function.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\n# get 4000 posterior draws for two hypothetical individuals\n# for scoring a given coffee\n\n# helper function for generating predictions\nmake_comparisons <-\n  function(fit,\n           pred_coffee,\n           pred_exp,\n           pred_age,\n           pred_gender) {\n    newdata <-\n      data.frame(\n        expertise = pred_exp,\n        age = pred_age,\n        gender = pred_gender,\n        coffee = pred_coffee\n      )\n    \n    return(posterior_epred(fit2, newdata = newdata))\n  }\n\n# get posterior draws\nZ <-\n  make_comparisons(\n    fit2,\n    pred_coffee = c(\"pref_d\"),\n    pred_exp = c(7, 5),\n    pred_age = \"25-34\",\n    pred_gender = c(\"Male\", \"Female\")\n  )\n\n# matrix of estimated differences\n# p1 - p2\np_diff <- Z[, 1, 1:5] - Z[, 2, 1:5]\n```\n:::\n\n\nThen we can put them into a dataframe and plot their distributions. As we can see, they are quite far apart. A 25-34 year old male with an expertise of 7 has a probability of about 35% of scoring coffee 'D' a 5, compared to 19% for female with an expertise of 5.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](coffee_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\nOne nice thing about a Bayesian approach is that we have access to the full posterior, so we can compute any kind of comparisons. For example, what is the predicted median difference between these two individuals rating coffee 'D' a 5, with an 89% credible interval?\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nquantile(p_diff[,5], probs = c(.06, .5, .94))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n       6%       50%       94% \n0.1386954 0.1519386 0.1651294 \n```\n:::\n:::\n\n\nOr we can plot the estimated difference of males and females for each of the response categories:\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](coffee_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\nOr what if we had two consumers with similarly rated expertise, but one was much older?\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nZ2 <-\n  make_comparisons(\n    fit2,\n    pred_coffee = \"pref_d\",\n    pred_exp = 6,\n    pred_age = c(\"25-34\", \"55+\"),\n    pred_gender = \"Male\"\n  )\n\np_diff_2 <- Z2[, 1, 1:5] - Z2[, 2, 1:5]\n\nquantile(p_diff_2[,5], probs = c(.06, .5, .94))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n       6%       50%       94% \n0.1952684 0.2140120 0.2323127 \n```\n:::\n:::\n\n\nWhich suggests that the probability of a 25-34 year old rating coffee 'D' a 5 is about *21 percentage points* higher than a 55+ year old individual. That's a huge age difference!\n\n## Full Data\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(tidyverse)\nlibrary(brms)\nlibrary(broom.mixed)\n\n# load survey data here\ncoffee <- read_csv(\"/gatt.csv\")\n\ncol_pal <- c( '#4477AA', '#EE6677', '#228833', '#CCBB44', '#66CCEE', '#AA3377')\n\nset.seed(123)\n\n## Function to extract random effects from brms model\npull_ranef <- function(x, idx){\n  return(\n    data.frame(x[,,idx]) %>%\n  mutate(coffee = rownames(.), variable = idx) \n  )\n}\n\n\n# Setup data\ncoffee_data <-\n  coffee %>%\n  select(\n    age = `What is your age?`,\n    gender = `Gender`,\n    expertise = `Lastly, how would you rate your own coffee expertise?`,\n    pref_a = `Coffee A - Personal Preference`,\n    pref_b = `Coffee B - Personal Preference`,\n    pref_c = `Coffee C - Personal Preference`,\n    pref_d = `Coffee D - Personal Preference`\n  ) %>%\n  replace_na(\n    list(\n      age = 'Not Provided',\n      gender = 'Not Provided',\n      race = 'Not Provided',\n      education = 'Not Provided'\n    )\n  )\n\ncoffee_ranking <-\n  coffee_data %>%\n  na.omit() %>%\n  select(age, gender, expertise, pref_a:pref_d) %>%\n  pivot_longer(cols = starts_with(\"pref\"),\n               names_to = \"coffee\",\n               values_to = \"ranking\") %>%\n  mutate(age = case_when(\n    age %in% c(\"<18 years old\",\"18-24 years old\") ~ \"18-24\",\n    age == \"25-34 years old\" ~ \"25-34\",\n    age == \"35-44 years old\" ~ \"35-44\",\n    age == \"45-54 years old\" ~ \"45-54\",\n    age %in% c(\"55-64 years old\", \">65 years old\") ~ \"55+\"\n  ))\n\n# fit model\nfit2 <-\n  brm(\n    ranking ~ 1 + \n      gender +\n      (age + expertise | coffee),\n    data = coffee_ranking,\n    prior = prior,\n    family = cumulative(\"probit\"),\n    chains = 4,\n    cores = 4,\n    iter = 2000,\n    control = list(adapt_delta = 0.99)\n  )\n\nstrata <- coffee_ranking %>%\n  filter(gender %in% c(\"Male\",\"Female\")) %>%\n  distinct(expertise, age, gender, coffee) %>%\n  complete(expertise,age,gender,coffee)\n\nfit1_preds <-\n  predict(fit2, newdata = strata) %>%\n  data.frame()\n\npred_data <-\n  tibble(strata, fit1_preds) %>%\n  set_names(c(\n    'expertise',\n    'age',\n    'gender',\n    'coffee',\n    'p1',\n    'p2',\n    'p3',\n    'p4',\n    'p5'\n  )) %>%\n  mutate(\n    gender = fct_relevel(gender, \"Male\"),\n    age = fct_relevel(\n      age,\n      \"18-24\",\n      \"25-34\",\n      \"35-44\",\n      \"45-54\",\n      '55+'\n    )\n  ) %>%\n  pivot_longer(cols = starts_with(\"p\"),\n               names_to = 'ranking',\n               values_to = 'prob')\n\n# random effects\nfit2_summary <- ranef(fit2)[[1]]\nvals <- c(\"Intercept\",\"age25M34\",\"age35M44\",\"age45M54\",\"age55P\",\"expertise\")\n\n# pull into nice dataframe\nres <-\n  sapply(vals, function(x) {\n    pull_ranef(fit2_summary, x)\n  },\n  simplify = FALSE) %>%\n  do.call(rbind, .)\n```\n:::",
    "supporting": [
      "coffee_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}